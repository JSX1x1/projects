#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <direct.h>  // For _rmdir on Windows
#include <unistd.h>  // For rmdir on Linux/Mac
#include <errno.h>

#ifdef _WIN32
#include <windows.h>
#define CLEAR "cls"
#else
#include <sys/stat.h>
#define CLEAR "clear"
#endif

#define LOG_FILE "deletion_log.txt"

// ‚ö†Ô∏è LEGAL DISCLAIMER:
// This tool is designed **only for authorized directory management** and **ethical system administration**.
// Unauthorized or reckless use may cause **permanent data loss** and can be **illegal**.
// 
// üö® **Do NOT use this script without explicit permission from the system owner!**
//
// ‚úîÔ∏è This tool will only execute if:
//     - The user has **Administrator privileges**.
//     - The deletion path is **validated as non-critical**.
//     - The user provides **explicit written confirmation** before deletion.
//
// The author is **NOT responsible** for any data loss, system damage, or legal consequences from misuse.

// Function to log deletion attempts
void logAction(const char *message) {
    FILE *log = fopen(LOG_FILE, "a+");
    if (log != NULL) {
        time_t now;
        time(&now);
        fprintf(log, "[%s] %s\n", ctime(&now), message);
        fclose(log);
    }
}

// Function to check if the user has administrative privileges
int isAdmin() {
    BOOL isAdmin = FALSE;
    SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
    PSID AdministratorsGroup;

    if (AllocateAndInitializeSid(&NtAuthority, 2, SECURITY_BUILTIN_DOMAIN_RID, 
                                 DOMAIN_ALIAS_RID_ADMINS, 0, 0, 0, 0, 0, 0, &AdministratorsGroup)) {
        CheckTokenMembership(NULL, AdministratorsGroup, &isAdmin);
        FreeSid(AdministratorsGroup);
    }
    return isAdmin;
}

// Function to validate the path and prevent deletion of critical system directories
int isPathSafe(const char *path) {
#ifdef _WIN32
    // Windows: Block deletion of critical system paths
    if (strstr(path, "C:\\Windows") != NULL || strstr(path, "C:\\Windows\\System32") != NULL ||
        strstr(path, "C:\\Program Files") != NULL || strstr(path, "C:\\Program Files (x86)") != NULL) {
        printf("[!] Cannot delete critical system paths. Operation aborted.\n");
        logAction("[!] Attempted deletion of a protected Windows directory.");
        return 0;
    }
#else
    // Linux/Mac: Block deletion of critical system paths
    if (strcmp(path, "/") == 0 || strcmp(path, "/root") == 0 || strstr(path, "/bin") != NULL ||
        strstr(path, "/sbin") != NULL || strstr(path, "/usr") != NULL || strstr(path, "/etc") != NULL) {
        printf("[!] Cannot delete critical system paths. Operation aborted.\n");
        logAction("[!] Attempted deletion of a protected Linux/Mac directory.");
        return 0;
    }
#endif
    return 1;
}

// Function to delete a directory based on the operating system
void deleteDirectory(const char *path) {
    char command[1024];

#ifdef _WIN32
    // Windows command to delete a directory forcefully and quietly
    snprintf(command, sizeof(command), "rd /s /q \"%s\"", path);
#else
    // Linux/Mac command to delete a directory recursively and forcefully
    snprintf(command, sizeof(command), "rm -rf \"%s\"", path);
#endif

    // Execute the delete command and check for errors
    int status = system(command);
    if (status != 0) {
        printf("[!] Failed to delete %s. Error code: %d\n", path, status);
        logAction("[!] Directory deletion failed.");
    } else {
        printf("[+] Successfully deleted %s\n", path);
        logAction("[+] Directory deleted successfully.");
    }
}

int main() {
    char path[512];

    // Ensure administrative privileges
    if (!isAdmin()) {
        printf("This tool requires **Administrator privileges**. Please run as Administrator.\n");
        logAction("[!] Attempted execution without admin rights.");
        return 1;
    }

    // Clear the console for better readability
    system(CLEAR);

    // Display a clear warning to the user
    printf("WARNING: This script can permanently delete entire directories!\n");
    printf("**Unauthorized or reckless use may cause system damage.**\n");
    printf("Do NOT use this tool without explicit permission!\n\n");

    // Prompt user for the absolute path to delete
    printf("[?] Enter the absolute path to delete: ");
    fgets(path, sizeof(path), stdin);
    path[strcspn(path, "\n")] = 0;  // Remove newline character

    // Validate if the provided path is too short or seems suspicious
    if (strlen(path) < 3) {
        printf("[!] Invalid path. Aborting.\n");
        logAction("[!] User provided an invalid path.");
        return 1;
    }

    // Check if the path is safe to delete
    if (!isPathSafe(path)) {
        return 1;  // Abort if path is unsafe
    }

    // Display the path to be deleted for user confirmation
    printf("\n[!] You are about to delete: %s\n", path);
    printf("[!] This action is **IRREVERSIBLE**. Proceed with caution!\n");

    // Request user confirmation to proceed with deletion
    char confirmation[16];
    printf("[?] Type 'CONFIRM_DELETE' to proceed: ");
    fgets(confirmation, sizeof(confirmation), stdin);
    confirmation[strcspn(confirmation, "\n")] = 0;  // Remove newline character

    // Proceed only if user types 'CONFIRM_DELETE'
    if (strcmp(confirmation, "CONFIRM_DELETE") == 0) {
        deleteDirectory(path);  // Call function to delete the specified path
    } else {
        printf("[!] Aborted by user.\n");
        logAction("[!] User aborted deletion operation.");
    }

    return 0;
}
