#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>
#include <stdint.h>
#include <openssl/md5.h>

#define BUFFER_SIZE 1024

// ⚠️ LEGAL DISCLAIMER:
// This program is designed for **ethical hacking**, **forensic analysis**, and **educational purposes** only.
// Unauthorized use, distribution, or deployment of this tool without proper consent is ILLEGAL and could result
// in criminal and civil penalties.
//
// If you are not the authorized owner of the system, DO NOT run this program.
// Do not use this code to monitor any processes or files without obtaining explicit and informed consent
// from all individuals involved.
//
// This tool is intended for controlled environments where you have received written permission from relevant parties,
// such as during cybersecurity exercises, penetration tests, or authorized audits.
//
// The author and repository maintainers are not responsible for any misuse, unlawful activities, or legal consequences
// resulting from the use of this software. Always ensure you have full authorization before running this tool.

// Function to calculate the MD5 hash of a file
void calculate_md5(const char *filename, unsigned char *result) {
    FILE *file = fopen(filename, "rb");
    if (!file) {
        printf("Error opening file: %s\n", filename);
        return;
    }

    MD5_CTX mdContext;
    MD5_Init(&mdContext);

    unsigned char buffer[BUFFER_SIZE];
    size_t bytesRead;
    while ((bytesRead = fread(buffer, 1, sizeof(buffer), file)) != 0) {
        MD5_Update(&mdContext, buffer, bytesRead);
    }

    MD5_Final(result, &mdContext);

    fclose(file);
}

// Function to print the MD5 hash as a string
void print_md5_hash(unsigned char *hash) {
    for (int i = 0; i < MD5_DIGEST_LENGTH; i++) {
        printf("%02x", hash[i]);
    }
    printf("\n");
}

// Function to list all files in a directory and calculate their MD5 hash
void list_files_and_hash(const char *directory) {
    WIN32_FIND_DATA findFileData;
    HANDLE hFind = FindFirstFile(strcat(directory, "\\*"), &findFileData);

    if (hFind == INVALID_HANDLE_VALUE) {
        printf("Error accessing directory: %s\n", directory);
        return;
    }

    do {
        if (findFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY) {
            // Skip "." and ".."
            if (strcmp(findFileData.cFileName, ".") != 0 && strcmp(findFileData.cFileName, "..") != 0) {
                char subDirectory[MAX_PATH];
                snprintf(subDirectory, sizeof(subDirectory), "%s\\%s", directory, findFileData.cFileName);
                list_files_and_hash(subDirectory);  // Recursively list subdirectories
            }
        } else {
            // List the file and calculate its MD5 hash
            printf("File: %s\\%s\n", directory, findFileData.cFileName);
            unsigned char hash[MD5_DIGEST_LENGTH];
            calculate_md5(findFileData.cFileName, hash);
            printf("MD5 Hash: ");
            print_md5_hash(hash);
        }
    } while (FindNextFile(hFind, &findFileData) != 0);

    FindClose(hFind);
}

// Function to list running processes
void list_processes() {
    printf("Listing running processes:\n");

    // This command will get the list of running processes in a Windows environment
    system("tasklist");
}

int main() {
    printf("Forensic Analysis Tool\n");
    printf("This program is intended for educational and authorized forensic analysis use only.\n");

    // 1. List files in a directory and calculate their hashes
    char directory[MAX_PATH];
    printf("Enter the directory path to analyze (e.g., C:\\Users\\YourName\\Documents): ");
    scanf("%s", directory);
    list_files_and_hash(directory);

    // 2. List running processes to detect suspicious activities
    list_processes();

    return 0;
}
