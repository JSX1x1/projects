#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#ifdef _WIN32
#include <windows.h>
#define CLEAR "cls"
#define LOG_FILE "action_log.txt"
#else
#include <unistd.h>
#define CLEAR "clear"
#define LOG_FILE "action_log.txt"
#endif

// ⚠️ WARNING: Use this script responsibly and only on files you own!
// ⚠️ Unauthorized use may violate computer misuse laws in your country.
// ⚠️ The author is NOT responsible for any damage caused by misuse!

// Function to log actions to a file
void logAction(const char *message) {
    FILE *log = fopen(LOG_FILE, "a+");
    if (log != NULL) {
        fprintf(log, "%s\n", message);
        fclose(log);
    }
}

// Function to lock a directory based on the operating system
void lockDirectory(const char *path) {
    char command[1024];

#ifdef _WIN32
    // Windows: Use icacls to restrict access but not fully deny admin
    snprintf(command, sizeof(command), "icacls \"%s\" /inheritance:d /grant:r Everyone:(RX)", path);
#else
    // Linux/Mac: Use chmod for restrictive permissions (500: read-execute only for owner)
    snprintf(command, sizeof(command), "chmod 500 \"%s\"", path);
#endif

    // Execute the lock command and log the action
    int status = system(command);
    if (status != 0) {
        printf("[!] Failed to lock %s. Error code: %d\n", path, status);
        logAction("[!] Lock failed");
    } else {
        printf("[+] Successfully locked %s\n", path);
        logAction("[+] Path locked successfully");
    }
}

// Function to unlock a directory based on the operating system
void unlockDirectory(const char *path) {
    char command[1024];

#ifdef _WIN32
    // Windows: Restore permissions using icacls
    snprintf(command, sizeof(command), "icacls \"%s\" /reset", path);
#else
    // Linux/Mac: Restore permissions using chmod (755 for full access)
    snprintf(command, sizeof(command), "chmod 755 \"%s\"", path);
#endif

    // Execute the unlock command and log the action
    int status = system(command);
    if (status != 0) {
        printf("[!] Failed to unlock %s. Error code: %d\n", path, status);
        logAction("[!] Unlock failed");
    } else {
        printf("[+] Successfully unlocked %s\n", path);
        logAction("[+] Path unlocked successfully");
    }
}

// Function to validate path to prevent misuse
int isPathValid(const char *path) {
#ifdef _WIN32
    // Prevent locking critical system paths on Windows
    if (strstr(path, "C:\\Windows\\System32") != NULL) {
        printf("[!] Cannot lock system paths. Operation aborted.\n");
        logAction("[!] Attempt to lock system path blocked");
        return 0;
    }
#else
    // Prevent locking critical system paths on Linux/Mac
    if (strcmp(path, "/") == 0 || strstr(path, "/root") != NULL) {
        printf("[!] Cannot lock system paths. Operation aborted.\n");
        logAction("[!] Attempt to lock system path blocked");
        return 0;
    }
#endif
    return 1;
}

int main() {
    char path[512];
    int choice;
    char consent;

    // Clear the console for better readability
    system(CLEAR);

    // Display a clear warning to the user
    printf("⚠️ WARNING: This script can lock folders, restricting access!\n");
    printf("Use at your own risk and only on files you own.\n");
    printf("The author is NOT responsible for any damage.\n\n");

    // Prompt user for the absolute path to lock
    printf("[?] Enter the absolute path to lock or unlock: ");
    fgets(path, sizeof(path), stdin);
    path[strcspn(path, "\n")] = 0;  // Remove newline character

    // Validate if the provided path is too short or seems suspicious
    if (strlen(path) < 3 || !isPathValid(path)) {
        printf("[!] Invalid path. Aborting.\n");
        logAction("[!] Invalid path detected");
        return 1;
    }

    // Display options to lock or unlock the path
    printf("\n[1] Lock Path\n[2] Unlock Path\n[?] Choose an option: ");
    scanf("%d", &choice);

    // Request explicit consent before proceeding
    printf("⚠️ Are you sure you want to proceed? (y/n): ");
    scanf(" %c", &consent);
    if (consent != 'y' && consent != 'Y') {
        printf("[!] Operation cancelled by user.\n");
        logAction("[!] User cancelled operation");
        return 1;
    }

    if (choice == 1) {
        lockDirectory(path);  // Call function to lock the path
    } else if (choice == 2) {
        unlockDirectory(path);  // Call function to unlock the path
    } else {
        printf("[!] Invalid choice. Aborting.\n");
        logAction("[!] Invalid menu choice");
    }

    return 0;
}
